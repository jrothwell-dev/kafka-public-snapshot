services:
  test-zookeeper:
    image: confluentinc/cp-zookeeper:7.9.0
    hostname: zookeeper
    container_name: test-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - test_zookeeper_data:/var/lib/zookeeper/data
      - test_zookeeper_log:/var/lib/zookeeper/log
    networks:
      - test-network

  test-kafka:
    image: confluentinc/cp-kafka:7.9.0
    hostname: kafka
    container_name: test-kafka
    depends_on:
      - test-zookeeper
    ports:
      - "9093:9092"  # External port 9093, internal 9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    volumes:
      - test_kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:29092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 40s
    networks:
      - test-network

  test-redis:
    image: redis:7-alpine
    hostname: redis
    container_name: test-redis
    ports:
      - "6380:6379"  # External port 6380, internal 6379
    volumes:
      - test_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  test-kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: test-kafka-ui
    depends_on:
      test-kafka:
        condition: service_healthy
    ports:
      - "8082:8080"  # External port 8082, internal 8080
    environment:
      KAFKA_CLUSTERS_0_NAME: test-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    networks:
      - test-network

  test-safetyculture-poller:
    build:
      context: ./services/safetyculture-poller
      dockerfile: Dockerfile
    container_name: test-safetyculture-poller
    environment:
      SAFETYCULTURE_API_TOKEN: ${SAFETYCULTURE_API_TOKEN}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      POLL_INTERVAL: ${POLL_INTERVAL:-300}
      REDIS_HOST: redis
    networks:
      - test-network
    restart: unless-stopped
    depends_on:
      test-kafka:
        condition: service_healthy
      test-redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  test-wwcc-transformer:
    build:
      context: ./services/wwcc-transformer
      dockerfile: Dockerfile
    container_name: test-wwcc-transformer
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      REDIS_HOST: redis
    networks:
      - test-network
    restart: unless-stopped
    depends_on:
      test-kafka:
        condition: service_healthy
      test-redis:
        condition: service_healthy
      test-safetyculture-poller:
        condition: service_started

  test-compliance-notification-router:
    build:
      context: ./services/compliance-notification-router
      dockerfile: Dockerfile
    container_name: test-compliance-notification-router
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      REDIS_HOST: redis
    networks:
      - test-network
    restart: unless-stopped
    depends_on:
      test-kafka:
        condition: service_healthy
      test-redis:
        condition: service_healthy
      test-wwcc-transformer:
        condition: service_started

  test-notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: test-notification-service
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      REDIS_HOST: redis
      SMTP_HOST: ${SMTP_HOST:-smtp.murrumbidgee.nsw.gov.au}
      SMTP_PORT: ${SMTP_PORT:-25}
      SMTP_FROM: ${SMTP_FROM:-noreply@murrumbidgee.nsw.gov.au}
    networks:
      - test-network
    restart: unless-stopped
    depends_on:
      test-kafka:
        condition: service_healthy
      test-redis:
        condition: service_healthy
      test-compliance-notification-router:
        condition: service_started

volumes:
  test_kafka_data:
  test_zookeeper_data:
  test_zookeeper_log:
  test_redis_data:

networks:
  test-network:
    name: council-kafka-platform_test-network
    driver: bridge

